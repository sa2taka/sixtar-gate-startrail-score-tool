# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a SIXTAR GATE STARTRAIL score extraction and management system with three main components:
- **score-extractor/**: Go-based OCR tool for extracting scores from game screenshots
- **web/**: Next.js web application for score management and visualization
- **music-information-scraping/**: TypeScript utility for scraping music metadata

## Development Commands

### Score Extractor (Go)
```bash
cd score-extractor
go build -o score_extractor main.go  # Build binary
go test ./...                        # Run all tests
go test ./internal/extract           # Run specific package tests
./score_extractor extract image.jpg  # Extract from single image
./score_extractor serve --config config.toml  # Start API server
```

### Web Application (Next.js)
```bash
cd web
pnpm dev              # Development server with Turbopack
pnpm build            # Production build (includes Prisma generation)
pnpm start            # Production server
pnpm lint             # ESLint code checking
pnpm script           # Run TypeScript scripts
pnpm prisma-local     # Local Prisma commands
```

### Music Information Scraping
```bash
cd music-information-scraping
pnpm tsx index.ts     # Scrape latest music data and generate musicInformation.json
```

### Code Quality
```bash
# Root level formatting (applies to all TypeScript/JavaScript)
pnpm format
pnpm format:check

# Web-specific linting
cd web && pnpm lint . --fix
```

## Next.js App Router Best Practices

### Server Components (RSC) でのデータ取得
- **デフォルトでServer Componentsを使用**: App Routerでは全てのコンポーネントがデフォルトでServer Component
- **データベース直接アクセス**: Server ComponentsではPrismaを使って直接DBクエリが可能（APIレイヤー不要）
- **async/await構文**: Server Componentsはasync関数として定義でき、useEffectやuseState不要
- **自動的な静的生成**: fetch結果は自動的にキャッシュされ、ビルド時に静的生成される

### パフォーマンス最適化
- **並列データフェッチ**: 複数のデータ取得は並列実行し、ウォーターフォールを避ける
- **Suspenseでストリーミング**: 遅いデータ取得にはSuspenseを使い、段階的にHTMLを送信
- **自動リクエストメモ化**: 同じfetchリクエストは自動的にメモ化される

### 実装パターン
```typescript
// app/page.tsx - Server Component
export default async function Page() {
  // 直接Prismaでデータ取得（APIルート不要）
  const [results, lastScore, statistics] = await Promise.all([
    prisma.result.findMany({ where: { userId } }),
    prisma.result.findFirst({ orderBy: { playedAt: 'desc' } }),
    getStatistics()
  ]);
  
  return <ClientComponent data={results} />;
}
```

### キャッシング戦略
- **デフォルト静的レンダリング**: ビルド時にプリレンダリング
- **動的レンダリング**: `{ cache: 'no-store' }` でオプトイン
- **再検証**: `{ next: { revalidate: 60 } }` で時間ベースの再検証

## Architecture

### Score Extraction Pipeline
1. **Image Processing**: Screenshots processed through OCR (Tesseract) for text extraction
2. **Data Extraction**: Structured extraction of scores, judgments, and metadata using internal/extract package
3. **API Serving**: HTTP API at `/api/v1/scores` for real-time data access
4. **Web Integration**: Next.js app polls score-extractor API for new results

### Database Design
- **Prisma ORM** with PostgreSQL backend
- **Users**: Google OAuth authentication
- **Music/Chart**: Song metadata and difficulty information
- **Result**: Individual score records with full judgment data

### Key Go Packages
- `internal/extract/`: Core score extraction logic with comprehensive test coverage
- `internal/imageproc/`: Image processing utilities (OCR, cropping, color analysis)
- `internal/music_info/`: Music metadata loading from JSON
- `cmd/extract/` and `cmd/serve/`: CLI command implementations

### Web Application Structure
- **App Router**: Next.js 15 with TypeScript, React Strict Mode enabled
- **Authentication**: NextAuth.js v5 (beta) with Google OAuth provider
  - Middleware protects all routes except `/auth/sign-in` and `/api/auth/*`
  - Session management with JWT strategy
- **UI Components**: shadcn/ui (Radix UI + Tailwind CSS)
  - Custom components in `src/components/ui/`
  - Available: Button, Checkbox, Form, Input, Label, Select
- **State Management**: TanStack Query for server state, React Hook Form for forms
- **Validation**: Zod schemas in `src/application/result-validation.ts`
- **Path Aliases**: `@/*` maps to `./src/*`

## Dependencies

### External Requirements
- **Tesseract OCR** with Japanese/Korean language packs (for score-extractor)
- **PostgreSQL** database (local Docker or cloud service)
- **Google OAuth** credentials for web authentication

### Shared Data
- `musicInformation.json`: Music metadata shared across all components, generated by scraping utility

## Configuration

### Environment Variables (web/.env.local)
```bash
# PostgreSQL (Vercel Postgres or local)
POSTGRES_PRISMA_URL=          # Connection pooling URL for Prisma
POSTGRES_URL_NON_POOLING=     # Direct connection URL

# NextAuth.js
AUTH_SECRET=                  # Generate with `openssl rand -base64 32`
AUTH_GOOGLE_ID=               # Google OAuth client ID
AUTH_GOOGLE_SECRET=           # Google OAuth client secret
```

### Configuration Files
- **score-extractor**: TOML config at `config.toml` (use `config.toml.example` as template)
- **Code formatting**: Biome config with tab indentation, 120 character line width, organize imports enabled
- **shadcn/ui**: Component configuration in `web/components.json`

## Development Workflow

### Initial Setup
1. **Database Setup**
   ```bash
   # Start PostgreSQL (Docker or cloud service)
   cd web
   # Configure .env.local with database URLs
   pnpm prisma-local db push        # Apply schema
   pnpm script scripts/insert-musics.ts  # Initialize music data
   ```

2. **Score Extractor Setup**
   - Install Tesseract OCR with Japanese/Korean language packs
   - Copy `config.toml.example` to `config.toml` and configure
   - Build with `go build -o score_extractor main.go`

3. **Start Development**
   ```bash
   # Terminal 1: Score extractor API
   cd score-extractor && ./score_extractor serve --config config.toml
   
   # Terminal 2: Next.js dev server
   cd web && pnpm dev
   ```

## Testing Strategy
- **Go**: Comprehensive unit tests in `internal/extract/` with test helper utilities
  - Run specific package: `go test ./internal/extract`
  - Debug tools: `coordinate-visualizer.html` for OCR coordinate verification
- **Web**: Focus on form validation and API integration testing
- **Test Data**: 
  - Go: `testdata/` directory with game mode samples
  - Web integration: `web_test/` directory

## Key Dependencies

### Go Packages
- `github.com/otiai10/gosseract/v2` - Tesseract OCR wrapper
- `github.com/gorilla/mux` - HTTP router
- `github.com/BurntSushi/toml` - Configuration parsing
- `github.com/agnivade/levenshtein` - String similarity for fuzzy matching

# Documentation

projects/ディレクトリ以下をあなたがわかりやすいような形で利用してください。タスクを開始・終了する度にprojects以下を参照し必要な情報を更新・作成してください。

一時的な情報はtmp/ディレクトリ以下に作成してください。
